version: '3.8'

services:
  voice-notes-api-test:
    build:
      context: ../..
      dockerfile: Dockerfile
    environment:
      - TESTING=true
      - OBSIDIAN_VAULT_PATH=/tmp/test_vault
      - UPLOAD_DIR=/tmp/test_uploads
      - SESSION_STORAGE_DIR=/tmp/test_sessions
      - MAX_UPLOAD_SIZE=52428800
      - PROCESSING_TIMEOUT=35
      - MAX_CONCURRENT_REQUESTS=3
      - WHISPER_MODEL_SIZE=base
      - OLLAMA_ENABLED=false  # Disable for testing
      - SESSION_TIMEOUT_HOURS=1
      - SESSION_CLEANUP_INTERVAL_MINUTES=5
      - MAX_SESSIONS_PER_USER=10
      - LOG_LEVEL=DEBUG
    volumes:
      - test_vault:/tmp/test_vault
      - test_uploads:/tmp/test_uploads
      - test_sessions:/tmp/test_sessions
    ports:
      - "8001:8000"  # Different port to avoid conflicts
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2.0'
        reservations:
          memory: 2G
          cpus: '1.0'

  ollama-test:
    image: ollama/ollama:latest
    environment:
      - OLLAMA_MODELS=/tmp/test_models
    volumes:
      - test_ollama:/tmp/test_models
    ports:
      - "11435:11434"  # Different port for testing
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 60s
      timeout: 15s
      retries: 5
      start_period: 120s
    deploy:
      resources:
        limits:
          memory: 8G
          cpus: '4.0'
        reservations:
          memory: 4G
          cpus: '2.0'

  # Test database for future use
  redis-test:
    image: redis:7-alpine
    ports:
      - "6380:6379"  # Different port for testing
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 3

volumes:
  test_vault:
    driver: local
  test_uploads:
    driver: local
  test_sessions:
    driver: local
  test_ollama:
    driver: local

networks:
  default:
    name: dialtone-test-network